<div align="center">
  <h1>Sistema de Extra√ß√£o de Tags de Imagens com Lambda e Rekognition</h1>
</div>

<div align="center">
  <p>Equipe 1</p>

  | Nome                                 | Linkedin                                                                                 |
  | ---------------                      | -------------------------------------------------------------------                      |
  | Cristofer Gaier Sais                 | [Link](https://www.linkedin.com/in/cristofer-sais-a293591a0)                             |
  | Jo√£o Victor Winderfeld Bussolotto    | [Link](https://www.linkedin.com/in/jo%C3%A3o-victor-winderfeld-bussolotto-aaa914145/)    |
  | Josu√© Mendon√ßa                       | [Link](https://www.linkedin.com/in/josu%C3%A9-mendon%C3%A7a-dev77/)                      |    
  | Luiz Paulo Grafetti Terres           | [Link](https://www.linkedin.com/in/luiz-paulo-grafetti-terres-aa577a274/)                |      


</div>

***

<a name="ancora"></a>

## üìñ Sum√°rio
- [1 - Objetivo](#ancora1)
  - [1.1 - Tecnologias Utilizadas](#ancora1-1)
- [2 - Desenvolvimento do Projeto](#ancora2)
  - [2.1 - Rota 1 - Get /](#ancora2-1)
  - [2.2 - Rota 2 - Get /v1](#ancora2-2)
  - [2.3 - Rota 3 - Get /v2](#ancora2-3)
  - [2.4 - Rota 4 - Post /v1/vision](#ancora2-4)
  - [2.5 - Rota 5 - Post /v2/vision](#ancora2-5)
  - [2.6 - HTTP Responses](#ancora2-6)
- [3 - Instala√ß√£o local e usabilidade deste resposit√≥rio em novo ambiente](#ancora3)
- [4 - Acesso √† Aplica√ß√£o e Como Utiliz√°-la](#ancora4)
- [5 - Estrutura de Pastas do Projeto](#ancora5)
- [6 - Arquitetura AWS](#ancora6)
- [7 - Dificuldades conhecidas](#ancora7)
- [8 - Fonte das Imagens Utilizadas no Projeto](#ancora8)
- [9 - Licen√ßa](#ancora9)

***
<a id="ancora1"></a>
# 1 - Objetivo

O objetivo do projeto √© desenvolver uma aplica√ß√£o para automatizar a an√°lise de imagens armazenadas no `S3` utilizando `AWS Lambda`, `Amazon Rekognition` e `API Gateway`. A primeira fun√ß√£o, acessada atrav√©s da rota `"/v1/vision"`, utiliza o `Amazon Rekognition` para identificar e retornar etiquetas associadas √† imagem, enquanto a segunda fun√ß√£o, acessada atrav√©s da rota `"/v2/vision"`, identifica a principal emo√ß√£o em cada rosto presente na imagem.

***

<a id="ancora1-1"></a>
- ## 1.1 - Tecnologias Utilizadas

  <div style="display: inline-block" align="center">
    <img align="center" alt="Python" height="30" src="https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg" />
    <img align="center" alt="Git" height="28" width="42" src="https://raw.githubusercontent.com/devicons/devicon/master/icons/git/git-original.svg">
    <img align="center" alt="AWS" height="28" width="42" src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Amazon_Web_Services_Logo.svg/1024px-Amazon_Web_Services_Logo.svg.png" />
    <img align="center" alt="Serverless" height="28" width="42" src="https://assets-global.website-files.com/60acbb950c4d6606963e1fed/611631cd314b2abec6c29ec0_bolt.svg" />
    <img align="center" alt="Amazon API Gateway" height="28" width="42" src="https://d2q66yyjeovezo.cloudfront.net/icon/fb0cde6228b21d89ec222b45efec54e7-0856e92285f4e7ed254b2588d1fe1829.svg" />
    <img align="center" alt="Amazon Lambda" height="28" width="42" src="https://d2q66yyjeovezo.cloudfront.net/icon/945f3fc449518a73b9f5f32868db466c-926961f91b072604c42b7f39ce2eaf1c.svg" />
    <img align="center" alt="Amazon Rekognition" height="28" width="42" src="https://d2q66yyjeovezo.cloudfront.net/icon/b7cb336b98f3c4db02fb13d4d671df5e-37a81abbdae00bac12e1ffcd0776093b.svg" />
    <img align="center" alt="Amazon IAM" height="28" width="42" src="https://d2q66yyjeovezo.cloudfront.net/icon/0ebc580ae6450fce8762fad1bff32e7b-0841c1f0e7c5788b88d07a7dbcaceb6e.svg" />

  </div>

***
<a id="ancora2"></a>

# 2 - Desenvolvimento do Projeto

O desenvolvimento do projeto envolveu a cria√ß√£o e configura√ß√£o de fun√ß√µes lambdas no `AWS Lambda`, habilitando o processamento de imagens armazenadas no `Amazon S3`, constru√≠das usando o framework `Serverless`. Utilizando o `AWS Rekognition`, as fun√ß√µes foram desenvolvidas com o objetivo de identificar informa√ß√µes relevantes nas imagens, como etiquetas descritivas e emo√ß√µes predominantes nos rostos detectados. A exposi√ß√£o das fun√ß√µes por meio do `API Gateway`, com endpoints "/v1/vision" e "/v2/vision", permitiu o acesso simplificado a esses servi√ßos via API. Al√©m disso, o framework `Serverless` tamb√©m foi utilizado para o provisionamento bucket S3 e gerenciamento das pol√≠ticas de acesso do `IAM` referente √†s fun√ß√µes Lambdas.

<a id="ancora2-1"></a>

- ## [2.1 - Rota 1 - Get /](https://84ua33iq3d.execute-api.us-east-1.amazonaws.com/)
  Resposta a ser entregue:
  
  ```json
    {
      "message": "Go Serverless v3.0! Your function executed successfully!",
      "input": {
          ...(event)
        }
    }
  ```

<a id="ancora2-2"></a>

- ## [2.2 - Rota 2 - Get /v1](https://84ua33iq3d.execute-api.us-east-1.amazonaws.com/v1)
  Resposta a ser entregue:

  ```json
    {
      "message": "VISION api version 1."
    }
  ```

<a id="ancora2-3"></a>

- ## [2.3 - Rota 3 - Get /v2](https://84ua33iq3d.execute-api.us-east-1.amazonaws.com/v2)
  Resposta a ser entregue:

  ```json
    {
      "message": "VISION api version 2."
    }
  ```

<a id="ancora2-4"></a>

- ## [2.4 - Rota 4 - Post /v1/vision](https://84ua33iq3d.execute-api.us-east-1.amazonaws.com/v1/vision)
  A API "v1/vision" permite a extra√ß√£o de tags de imagens armazenadas no `Amazon S3`. Ao enviar uma solicita√ß√£o POST com o nome do bucket e da imagem desejada, a API utiliza a fun√ß√£o de `Detec√ß√£o de R√≥tulos` do `Amazon Rekognition` para processar a imagem. Em resposta, a API fornece as tags extra√≠das, incluindo a confian√ßa da detec√ß√£o, o link da imagem e a data de cria√ß√£o da mesma.

  Exemplo de entrada:

  ```json
    {
      "bucket": "bucket-computer-vision-s8",
      "imageName": "single_face_1.png"
    }
  ```

  Exemplo de retorno:

  ```json
  {
      "url_to_image": "https://bucket-computer-vision-s8.s3.amazonaws.com/single_face_1.png",
      "created_image": "28-09-2023 14:29:41",
      "labels": [
          {
              "Confidence": 99.99998474121094,
              "Name": "Glasses"
          },
          (...)
      ]
  }
  ```

<a id="ancora2-5"></a>

- ## [2.5 - Rota 5 - Post /v2/vision](https://84ua33iq3d.execute-api.us-east-1.amazonaws.com/v2/vision)
  A API "v2/vision" tem como foco a detec√ß√£o de rostos em imagens armazenadas no `Amazon S3`. Ao enviar uma solicita√ß√£o POST com o nome do bucket e da imagem desejada, a API utiliza a fun√ß√£o de `An√°lse Facial` do `Amazon Rekognition` para analisar a imagem em busca de faces. Ela retorna informa√ß√µes sobre os rostos detectados, incluindo a localiza√ß√£o, idade estimada e g√™nero das pessoas na imagem, bem como o link da imagem e sua data de cria√ß√£o.

  Exemplo de entrada:

  ```json
    {
        "bucket": "bucket-computer-vision-s8",
        "imageName": "multiple_faces_6.jpg"
    }
  ```
  Sa√≠da: 

  ```json
    {
        "url_to_image": "https://bucket-computer-vision-s8.s3.amazonaws.com/multiple_faces_6.jpg",
        "created_image": "28-09-2023 14:29:40",
        "faces": [
            {
                "position": {
                    "Height": 0.6058058142662048,
                    "Left": 0.4741848111152649,
                    "Top": 0.2359217256307602,
                    "Width": 0.3144436180591583
                },
                "classified_emotion": "CALM",
                "classified_emotion_confidence": 83.18921661376953
            },
            {
                "position": {
                    "Height": 0.571341335773468,
                    "Left": 0.2057298868894577,
                    "Top": 0.34210315346717834,
                    "Width": 0.2855561077594757
                },
                "classified_emotion": "HAPPY",
                "classified_emotion_confidence": 99.9555435180664
            }
        ]
    }
  ```
  Quando n√£o houver face:

  Exemplo de entrada:

  ```json
    {
      "bucket": "bucket-computer-vision-s8",
      "imageName": "car_1.jpg"
    } 
  ```

  Sa√≠da: 

  ```json
    {
        "url_to_image": "https://bucket-computer-vision-s8.s3.amazonaws.com/car_1.jpg",
        "created_image": "28-09-2023 14:29:39",
        "faces": [
            {
                "position": {
                    "Height": null,
                    "Left": null,
                    "Top": null,
                    "Width": null
                },
                "classified_emotion": null,
                "classified_emotion_confidence": null
            }
        ]
    }
  ```

***
<a id="ancora2-6"></a>

- ## HTTP Responses

  | Status Code |  Mensagem | 
  |:----------------:|-------------------------------------------------------|
  |`200` |Ok|
  |`400` |Missing required parameter|
  |`403` |You do not have permission to access this bucket|
  |`404`|  Invalid S3 Object or S3 Image                                                     |
  ||The requested resource could not be found. Please double-check the bucket name and try again.|
  ||The requested file could not be found in the bucket. Please double-check the imageName and try again|
  |`429`|Rate limit exceeded while processing the request|
  |`500`|An error occurred in Amazon Rekognition|
  ||An error occurred in Amazon S3|
  ||Internal server error|

<a id="ancora3"></a>

# 3 - Instala√ß√£o local e usabilidade deste resposit√≥rio em novo ambiente

0. Garanta possuir uma conta v√°lida da AWS. Crie um IAM role para a conta, e o adicione suas credenciais ao seu arquivo `~/.aws/credentials`

1. Fa√ßa o clone deste projeto a partir do github

```bash
git clone -b equipe-3 --single-branch https://github.com/Compass-pb-aws-2023-FURG-IFRS-UFFS/sprint-8-pb-aws-furg-ifrs-uffs && cd sprint-8-pb-aws-furg-ifrs-uffs
```

2. Mude para a pasta `visao-computacional` e altere o nome do arquivo em `example.env` para `.env` 

```bash
cd ./visao-computacional &&
mv ./example.env ./.env
```

3. Coloque um nome dispon√≠vel do S3 no primeiro atributo do novo arquivo `.env` : `BUCKET_NAME=your-bucket-name-here`

4. Instale corretamente todos os plugins que s√£o utilizados no projeto em `serverless.yml` e fa√ßa deploy

```bash
sls plugin install -n serverless-offline &&
sls plugin install -n serverless-python-requirements &&
sls deploy
```

5. Para fazer upload das imagens em `dataset/images/` para o seu novo bucket em um ambiente linux:

```bash
cd dataset/
./sync_s3.sh
```
Obs: Caso ocorra algum erro durante o passo 5 com o nome do bucket, confira se sua .env possui caracteres windows n√£o suportado pelo bash. Caso ocorra a falha, recomenda-se usar a ferramenta dos2unix no arquivo .env: `dos2unix ./../visao-computacional/.env` e rodar novamente `./sync_s3.sh`.

Com isso agora, voc√™ j√° possui um bucket, e uma vers√£o est√°vel de aplica√ß√£o lambda na AWS. Testes podem ser feitos por meio de ferramentas como o Postman, Curl, entre outros. Pode tamb√©m seguir para o `4 - Acesso √† Aplica√ß√£o e Como Utiliz√°-la` para mais informa√ß√µes de como utilizar a aplica√ß√£o usando a extens√£o `Rest Client` do VSCode.

Agora voc√™ poder√° fazer altera√ß√µes locais no seu ambiente, e test√°-las sem fazer deploy usando o comando:

```bash
sls offline
```

<a id="ancora4"></a>

# 4 - Acesso √† Aplica√ß√£o e Como Utiliz√°-la

## **[Link](https://84ua33iq3d.execute-api.us-east-1.amazonaws.com/)**

Para facilitar o teste das APIs do projeto, configuramos o Visual Studio Code para recomendar a instala√ß√£o da extens√£o "Rest Client API".

<div align="center">
    <img src = "./assets/extensao.png">
</div>

  ## Passo 1: Instale a extens√£o "Rest Client"

  Se voc√™ j√° a tem instalada, pode pular este passo. Caso n√£o apare√ßa a recomenda√ß√£o no Visual Studio Code, siga estas etapas:

  1. V√° para a aba "Extensions" (Extens√µes) na barra lateral esquerda.
  2. Clique em "Install" (Instalar) ao lado da extens√£o oferecida por "donebd".
  
  ## Passo 2: Configurar o settings.json
  
  
  1. Configurar o settings.json para usar o REST Client
  - DOCS: https://marketplace.visualstudio.com/items?itemName=humao.rest-client&ssr=false#overview
  - TUTORIAL: https://courses.codewithandrea.com/courses/783023/lectures/14364306
  ## Passo 3: Abra um arquivo .http

  Agora que voc√™ tem a extens√£o instalada e configurada, siga estas etapas para abrir e executar um arquivo .http:

  1. Navegue at√© a pasta "http_requests" no seu projeto.
  2. Abra o arquivo .http correspondente √† rota ou funcionalidade que deseja testar.

  ## Passo 4: Execute a solicita√ß√£o HTTP

  Para executar a solicita√ß√£o HTTP e testar a API, siga estas etapas:

  1. Clique no bot√£o "Send Request" (Enviar Solicita√ß√£o) no canto superior direito da solicita√ß√£o no arquivo .http.
  2. Aguarde a resposta da API. Ela ser√° exibida na parte inferior do Visual Studio Code, na guia "Output" (Sa√≠da).
  3. Voc√™ ver√° a resposta da API, incluindo o c√≥digo de status HTTP e o corpo da resposta, na guia "Output".


<a id="ancora5"></a>

# 5 - Estrutura de Pastas do Projeto

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ .vscode
‚îÇ   ‚îú‚îÄ‚îÄ extensions.json
‚îÇ   ‚îî‚îÄ‚îÄ settings.json
‚îú‚îÄ‚îÄ dataset
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ images
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ car_1.jpg
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ...
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ single_face_9.png
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ sync_s3.sh
‚îî‚îÄ‚îÄ visao-computacional
    ‚îú‚îÄ‚îÄ controllers
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ v1Controller.py
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ v2Controller.py
    ‚îú‚îÄ‚îÄ core
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ config.py
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ exceptions.py
    ‚îú‚îÄ‚îÄ .env
    ‚îú‚îÄ‚îÄ exceptions
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ aws_exceptions
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ base_exception.py
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ user_exceptions
    ‚îú‚îÄ‚îÄ http_requests
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ...
    ‚îú‚îÄ‚îÄ middleware
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ exception_handler.py
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îú‚îÄ‚îÄ routes
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ health.py
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ v1
    ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ...
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ v2
    ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ...
    ‚îú‚îÄ‚îÄ serverless.yml
    ‚îú‚îÄ‚îÄ services
    ‚îî‚îÄ‚îÄ utils.py
```

***

<a id="ancora6"></a>

# 6 - Arquitetura AWS

  <div align="center">
    <img src = "./assets/s8-arch-aws.drawio.png">
  </div>



***

<a id="ancora7"></a>

# 7 - Dificuldades conhecidas

1. Dificuldade de integrar os c√≥digos de erro dos servi√ßos da AWS.


<a id="ancora8"></a>

# 8 - Fonte das Imagens Utilizadas no Projeto

- [NVlabs/ffhq-dataset: Flickr-Faces-HQ Dataset (FFHQ) (github.com)](https://github.com/NVlabs/ffhq-dataset/tree/master)
- [The Images of Groups Dataset (cornell.edu)](http://chenlab.ece.cornell.edu/people/Andy/ImagesOfGroups.html)
- [AutoAndRoad](AutoAndRoad.com)
- [graphassets](graphassets.com)
- [redbookmarks](redbookmarks.com)
- [autotrader](autotrader.com)
- [usnews](usnews.com)

<a id="ancora9"></a>

# 9 - Licen√ßa

Este projeto est√° licenciado sob a Licen√ßa MIT - consulte o [Link](https://mit-license.org/) para obter mais detalhes.